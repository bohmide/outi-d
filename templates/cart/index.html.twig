{% extends 'base.html.twig' %}

{% block body %}
	<div class="container my-5">
		<h1 class="mb-4 text-center">Mon Panier</h1>

		{% if cart is empty %}
			{% set messages = app.flashes('paymeeSuccess') %}

			{% if messages %}
				{% for message in messages %}
					<div class="alert alert-success text-center" role="alert">
						<p>{{message}}</p>
					</div>
				{% endfor %}

			{% else %}
				<div class="alert alert-warning text-center" role="alert">
					Votre panier est vide.
				</div>
			{% endif %}

		{% else %}
			<div class="table-responsive">
				<table class="table table-bordered text-center align-middle">
					<thead class="table-dark">
						<tr>
							<th>Produit</th>
							<th>Prix</th>
							<th>Sous-total</th>
							<th>Actions</th>
						</tr>
					</thead>
					<tbody>
						{% for key, item in cart %}
							<tr>
								<td>{{ item.name }}</td>
								<td>{{ item.price }}
									dt</td>

								<td>
									<strong>{{ item.price * item.quantity }}
										dt</strong>
								</td>
								<td>
									<a href="{{ path('cart_remove', {'key': key}) }}" class="btn btn-sm btn-danger">❌</a>
								</td>
							</tr>
						{% endfor %}
					</tbody>
					<tfoot>
						<tr class="table-info">
							<td colspan="3" class="text-end">
								<strong>Total :</strong>
							</td>
							<td colspan="2">
								<strong>{{ total }}
									dt</strong>
							</td>
						</tr>
					</tfoot>
				</table>
			</div>

			<div class="text-center mt-4">
				<a href="{{ path('cart_clear') }}" class="btn btn-danger btn-lg rounded-pill px-4 py-2 me-2 shadow-sm" style="transition: all 0.3s ease; font-weight: 600;">
					Vider le panier
				</a>
				<a href="{{ path('cart_clear') }}" class="btn btn-success btn-lg rounded-pill px-4 py-2 shadow-sm" id="participate-btn" style="transition: all 0.3s ease; font-weight: 600;">
					Payer
				</a>
			</div>


		{% endif %}
	</div>


	<button id="participate-btn">Participer</button>
	<script>
		document.addEventListener("DOMContentLoaded", function () {
let participateBtn = document.getElementById("participate-btn");

if (participateBtn) {
participateBtn.addEventListener("click", function () {
let totalAmount = {{ total|default(0) }};

if (isNaN(totalAmount) || totalAmount <= 0) {
alert("Erreur: Montant invalide !");
return;
}

fetch("https://127.0.0.1:8000/payment/initiate", {
method: "POST",
headers: {
"Content-Type": "application/json"
},
body: JSON.stringify(
{
amount: totalAmount,
first_name: "Ahmed",
last_name: "Doe",
email: "ahmed@example.com",
phone: "+21611223344"
}
)
}).then(response => response.json()).then(data => {
console.log("Réponse API Paymee:", data);

if (data.payment_url) {
window.location.href = data.payment_url;
} else {
console.error("Erreur lors du paiement :", data);
alert("Erreur lors du paiement : " + (
data.details ?. message || "Réponse invalide de l'API"
));
}
}).catch(error => {
console.error("Erreur:", error);
alert("Une erreur s'est produite lors du paiement. Veuillez réessayer.");
});
});
}
});
	</script>

{% endblock %}
