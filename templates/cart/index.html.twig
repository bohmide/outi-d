{% extends 'base.html.twig' %}

{% block body %}
	<div class="container my-5">
		<h1 class="mb-4 text-center">üõí Mon Panier</h1>

		{% if cart is empty %}
			<div class="alert alert-warning text-center" role="alert">
				Votre panier est vide.
			</div>
		{% else %}
			<div class="table-responsive">
				<table class="table table-bordered text-center align-middle">
					<thead class="table-dark">
						<tr>
							<th>Produit</th>
							<th>Prix</th>
							<th>Sous-total</th>
							<th>Actions</th>
						</tr>
					</thead>
					<tbody>
						{% for key, item in cart %}
							<tr>
								<td>{{ item.name }}</td>
								<td>{{ item.price }}
									dt</td>

								<td>
									<strong>{{ item.price * item.quantity }}
										dt</strong>
								</td>
								<td>
									<a href="{{ path('cart_remove', {'key': key}) }}" class="btn btn-sm btn-danger">‚ùå</a>
								</td>
							</tr>
						{% endfor %}
					</tbody>
					<tfoot>
						<tr class="table-info">
							<td colspan="3" class="text-end">
								<strong>Total :</strong>
							</td>
							<td colspan="2">
								<strong>{{ total }}
									dt</strong>
							</td>
						</tr>
					</tfoot>
				</table>
			</div>

			<div class="text-center mt-4">
				<a href="{{ path('cart_clear') }}" class="btn btn-danger">
					üóëÔ∏è Vider le panier
				</a>
			</div>
		{% endif %}
	</div>
	<p>Debug: Total =
		{{ total }}</p>

	<button id="participate-btn">Participer</button>
	<script>
		document.getElementById("participate-btn").addEventListener("click", function () {
let totalAmount = {{ total|default(0) }};

if (isNaN(totalAmount) || totalAmount <= 0) {
alert("Erreur: Montant invalide !");
return;
}

fetch("http://127.0.0.1:8000/payment/initiate", {
method: "POST",
headers: {
"Content-Type": "application/json"
},
body: JSON.stringify(
{
amount: totalAmount,
first_name: "Ahmed",
last_name: "Doe",
email: "ahmed@example.com",
phone: "+21611223344"
}
)
}).then(response => response.json()).then(data => {
console.log("R√©ponse API Paymee:", data);
if (data.payment_url) {
window.location.href = data.payment_url;
} else {
alert("Erreur lors du paiement: " + (
data.details ?. message || "R√©ponse invalide"
));
}
}).catch(error => console.error("Erreur:", error));
});
	</script>


{% endblock %}
